"use strict";const e=require("../../common/vendor.js"),a=require("../api/api.js"),l=require("../../utils/common.js"),n=require("../../api/qualityCheck/qualityCheck.js");if(!Array){(e.resolveComponent("custom-header")+e.resolveComponent("van-empty")+e.resolveComponent("uv-upload")+e.resolveComponent("uni-collapse-item")+e.resolveComponent("uni-collapse")+e.resolveComponent("uni-popup"))()}const o=()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js";Math||((()=>"../../components/custom-header/custom-header.js")+s+(()=>"../../uni_modules/uv-upload/components/uv-upload/uv-upload.js")+(()=>"../../uni_modules/uni-collapse/components/uni-collapse-item/uni-collapse-item.js")+(()=>"../../uni_modules/uni-collapse/components/uni-collapse/uni-collapse.js")+e.unref(u)+o)();const s=()=>"../../uni_modules/qiao-select/components/qiao-select/qiaoSelect.js",u=()=>"./components/finenessJudgePannel.js",t={__name:"finenessJudge",setup(o){const s=e.getCurrentInstance(),u=e.ref(null),t=async()=>{i();try{const e=await l.scanCode();console.log("result",e),e&&g(e).then((()=>{A.value.length>0&&(u.value.inputText=A.value[0].ch)}))}catch(e){console.error("扫码失败：",e)}finally{c()}},i=()=>{e.index.showLoading({title:"加载中...",mask:!0})},c=()=>{e.index.hideLoading()},r=e.ref(null),v=e.ref(null),p=e.ref(!1),m=e.ref("ch"),d=e.ref("ch"),g=e=>{e.length>0&&G(e)},f=a=>{console.log("e:",a),p.value=!1,e.index.showModal({content:"退出质检流程再次质检请根据串号搜索",showCancel:!0,success:e=>{e.cancel?p.value=!0:(console.log("用户点击了确认"),l.navigateToPage("pagesCustomMine/customMine/customMine"))}})},h=e.ref(3),j=e.reactive({}),w=e.ref([]),y=(e,a)=>{console.log("isOpen:",e),w.value[a]=e.length>0,console.log("collapsedStatus:",w.value)},x=e.ref([]),k=e.ref([]),b=(e,a)=>{x.value[e]=a,k.value[e]=a.name,console.log("clickedItems:",x.value),console.log("selectedText:",k.value),N(e,a.id),"1"===a.tpbs?C.value[e]=!0:C.value[e]=!1,console.log("showUpdateMap",C.value)},C=e.ref([!1,!1,!1]),I=(e,a)=>x.value[e]===a,z=(e,a)=>{l.uploadFilesByIndex(e,a,j)},T=(e,a)=>{l.uploadDeleteByIndex(e,a,j)},S=e.ref(!1),F=e.ref(null),P=e.ref(null),q=()=>{console.log("Popup is closed"),F.value.close()},L=e=>{e.show||(S.value=e.show)},_=e.reactive({remark:""}),R=e.ref(""),A=e.ref([]),M=async e=>{if(console.log("selectChange:",e),Object.keys(j).forEach((e=>{j[e]=[]})),e){console.log("selectChange e:",e);const{name:a,ch:n,machinetime:o,jkuidname:s,id:u,functionaltime:t,gnjcuidname:i,servicetime:c,serviceuidname:r,cgyname:v,finenessname:p,csbz:m,jswg:d,pmwg:g,yjid:f,jkbz:h,gnjcbz:w,wxjcbz:y,yjxsimg:x,pmwgimg:k,jswgimg:b}=e;W.value={spname:a,imei:n,inputTime:l.formatTimestamp(o),inputPerson:s,funcInputTime:l.formatTimestamp(t),funcInputPerson:i,maintenanceInputTime:l.formatTimestamp(c),maintenanceInputPerson:r,cgyname:v,cgyname:v,zjid:u,finenessname:p},O.jswg=d,O.pmwg=g,O.yjig=f,R.value=h+" "+w+" "+y,_.remark=m,j[0]=b?b.split(",").map((e=>({url:e}))):[],j[1]=k?k.split(",").map((e=>({url:e}))):[],j[2]=x?x.split(",").map((e=>({url:e}))):[],await U(u),B(J.value,O.jswg,0),B(J.value,O.pmwg,1),D(E.value,O.yjig),await V()}},B=(e,a,l)=>{console.log("updateSelection:",e,a,l),e.forEach((e=>{e.erlist.forEach(((e,n)=>{e.id===a&&(x.value[l]=e,k.value[l]=e.name,n>=2&&(w.value[l]=!0),"1"===e.tpbs?C.value[l]=!0:C.value[l]=!1)}))}))},D=(e,a)=>{console.log("updateYjSelection:",e,a),e.forEach(((e,l)=>{if(e.id===a){const a=J.value.length;x.value[a]=e,k.value[a]=e.name,O.yjig=e.id,l>=2&&(w.value[a]=!0),"1"===e.tpbs?C.value[a]=!0:C.value[a]=!1,console.log("selectedText:",k.value)}}))},J=e.ref([]),E=e.ref([]),O=e.reactive({jswg:"",pmwg:"",yjig:""}),N=(e,a)=>{0===e?O.jswg=a:1===e?O.pmwg=a:O.yjig=a,O.jswg&&O.pmwg&&O.yjig&&V()},Q=()=>{resetFormData()},U=async e=>{const l=await a.apiFinanceItemList({id:e});1===l.zt&&(J.value=l.lists,E.value=l.yjlist,w.value=Array.from({length:J.value.length+E.value.length},(()=>!1)),k.value=Array.from({length:J.value.length+E.value.length},(()=>"")),x.value=Array.from({length:J.value.length+E.value.length},(()=>null)),console.log("csList:",J.value),console.log("clickedItems:",x.value),console.log("collapsedStatus:",w.value),console.log("yjlist:",E.value),D(E.value,l.fcyjid))},V=async()=>{const l={id:W.value.zjid,jswg:O.jswg,pmwg:O.pmwg,yjid:O.yjig},n=await a.apiFinanceData(l);1===n.zt&&n.csinfos?P.value=n.csinfos:e.index.showToast({title:"请联系客服",icon:"none",duration:2e3})},K=async()=>{console.log("fileListRef:",j),console.log("fileListRef[0]:",j[0]);const l=j[0]&&j[0].map((e=>e.url)).join(",")||"",n=j[1]&&j[1].map((e=>e.url)).join(",")||"",o=j[2]&&j[2].map((e=>e.url)).join(",")||"",s={opid:JSON.parse(e.index.getStorageSync("userInfo")).opid,id:W.value.zjid,csname:P.value.name,csid:P.value.id,bz:_.remark,jswg:O.jswg,pmwg:O.pmwg,yjid:O.yjig,jswgimg:l,pmwgimg:n,yjxsimg:o};1===(await a.apiFinanceSave(s)).zt?(W.value.finenessName=P.value.name,W.value.csbz=_.remark,"QC"!==H.value?(S.value=!0,r.value.getData(W.value.imei),F.value.open()):e.index.showToast({title:"提交成功",icon:"none",duration:2e3})):e.index.showToast({title:"上传失败，请重试",icon:"none",duration:500})},Y=()=>{if(console.log("clickedItems:",x.value),console.log("fileListRef:",j),!P.value||!P.value.name)return void e.index.showToast({title:"请先判断成色",icon:"none",duration:2e3});let a=!1;x.value.some(((l,n)=>!(!l||"1"!==l.tpbs||j&&Array.isArray(j[n])&&0!==j[n].length)&&(e.index.showToast({title:`请为"${l.name}"上传图片`,icon:"none",duration:2e3}),a=!0,!0))),a||K()},G=async a=>{const l={opid:e.index.getStorageSync("sessionInfo").opid,ch:a},o=await n.apiQualityCheckSerialSearch(l);if(200===o.code)return o.lists=o.lists.filter((e=>""!==e.service)),A.value=o.lists?o.lists:[]},H=e.ref(""),W=e.ref(null);return e.onLoad((e=>{if(e.data)try{p.value=!0,W.value=JSON.parse(decodeURIComponent(e.data)),R.value=W.value.jkbz+" "+W.value.gnjcbz+" "+W.value.wxjcbz,console.log("Received data:",W.value),U(W.value.zjid)}catch(a){console.error("Failed to parse received data:",a)}e.ch&&G(e.ch).then((e=>{M(e[0])})),e.from&&(H.value=e.from)})),(a,n)=>e.e({a:p.value&&W.value},p.value&&W.value?{b:p.value,c:e.o(f)}:{},{d:e.p({backgroundColor:"#F3F2F6"}),e:e.sr(u,"1029d670-1",{k:"searchInputRef"}),f:e.o(g),g:e.o(M),h:e.p({keyId:10,phText:"请输入串号",dataList:A.value,searchKey:m.value,showBorder:!1,disabled:!1,showField:d.value}),i:e.o(t),j:!W.value},W.value?{}:{k:e.p({description:"请搜索相关商品进行拍照"})},{l:W.value},W.value?{m:e.t(W.value.spname),n:e.t(W.value.imei),o:e.o((a=>e.unref(s).proxy.copyText(W.value.imei))),p:e.t(W.value.cgyname),q:e.t(W.value.inputPerson),r:e.t(W.value.funcInputPerson),s:e.t(W.value.maintenanceInputPerson),t:e.t(R.value)}:{},{v:W.value},W.value?{w:e.t(P.value?P.value.name:W.value.finenessname?W.value.finenessname:"请判断成色")}:{},{x:W.value&&J.value.length>0},W.value&&J.value.length>0?{y:e.f(J.value,((a,n,o)=>e.e({a:e.t(a.name),b:e.t(k.value[n]),c:a.erlist.length>2},a.erlist.length>2?{d:w.value[n]?1:""}:{},{e:e.f(a.erlist.slice(0,2),((a,l,o)=>({a:e.t(a.name),b:I(n,a)?1:"",c:I(n,a)?1:"",d:l,e:e.o((e=>b(n,a)),l)}))),f:a.erlist.length>2},a.erlist.length>2?{g:e.f(a.erlist.slice(2),((a,l,o)=>({a:e.t(a.name),b:I(n,a)?1:"",c:I(n,a)?1:"",d:l+2,e:e.o((e=>b(n,a)),l+2)})))}:{},{h:C.value[n]},C.value[n]?{i:e.o((a=>e.unref(l.uploadCheack)(a,n)),n),j:e.o((e=>T(e,n)),n),k:"1029d670-5-"+o+",1029d670-4-"+o,l:e.p({fileList:j[n]||[],accept:"image",maxCount:h.value,maxSize:"5242880",width:"152rpx",height:"152rpx",sizeType:["compressed"],previewFullImage:!0,previewFullVideo:!1,"after-read":e=>z(e,n)})}:{},{m:"1029d670-4-"+o+",1029d670-3-"+o,n:e.p({"show-arrow":!1,open:w.value[n],titleBorder:"none",border:!1}),o:e.sr(v,"1029d670-3-"+o,{k:"collapseRef",f:1}),p:e.o((e=>y(e,n)),n),q:"1029d670-3-"+o,r:n})))}:{},{z:W.value&&E.value.length>0},W.value&&E.value.length>0?e.e({A:e.t(k.value[2]),B:E.value.length>2},E.value.length>2?{C:w.value[2]?1:""}:{},{D:e.f(E.value.slice(0,2),((a,l,n)=>({a:e.t(a.name),b:I(2,a)?1:"",c:I(2,a)?1:"",d:l,e:e.o((e=>b(2,a)),l)}))),E:E.value.length>2},E.value.length>2?{F:e.f(E.value.slice(2),((a,l,n)=>({a:e.t(a.name),b:I(2,a)?1:"",c:I(2,a)?1:"",d:l+2,e:e.o((e=>b(2,a)),l+2)})))}:{},{G:C.value[2]},C.value[2]?{H:e.o((a=>e.unref(l.uploadCheack)(a,2))),I:e.o((e=>T(e,2))),J:e.p({"file-list":j[2]||[],accept:"image",maxCount:h.value,maxSize:"5242880",width:"152rpx",height:"152rpx",sizeType:["compressed"],previewFullImage:!0,previewFullVideo:!1,"after-read":e=>z(e,2)})}:{},{K:e.p({"show-arrow":!1,open:w.value[2],titleBorder:"none",border:!1}),L:e.sr(v,"1029d670-6",{k:"collapseRef"}),M:e.o((e=>y(e,2)))}):{},{N:W.value},W.value?{O:_.remark,P:e.o((e=>_.remark=e.detail.value))}:{},{Q:W.value},(W.value,{}),{R:W.value},W.value?{S:e.o(Q),T:e.o(Y)}:{},{U:e.sr(r,"1029d670-10,1029d670-9",{k:"finenessJudgePannelRef"}),V:e.o(q),W:e.p({receivedData:W.value,csinfos:P.value}),X:e.sr(F,"1029d670-9",{k:"pannelPopup"}),Y:e.o(q),Z:e.o(L),aa:e.p({"background-color":"rgba(0,0,0,0)","is-mask-click":!0,"safe-area":!1,type:"center"})})}},i=e._export_sfc(t,[["__scopeId","data-v-1029d670"]]);wx.createPage(i);
