"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/common.js"),o=require("../../api/qualityCheck/qualityCheck.js");if(!Array){(e.resolveComponent("custom-header")+e.resolveComponent("van-empty")+e.resolveComponent("uv-upload")+e.resolveComponent("uni-popup"))()}const n=()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js";Math||((()=>"../../components/custom-header/custom-header.js")+l+(()=>"../../uni_modules/uv-upload/components/uv-upload/uv-upload.js")+e.unref(a)+n+e.unref(i))();const i=()=>"./components/cusfloatButtom.js",a=()=>"./components/takePhotoConfirmPannel.js",l=()=>"../../uni_modules/qiao-select/components/qiao-select/qiaoSelect.js",s={__name:"takePhoto",setup(n){const i=e.index.getStorageSync("sessionInfo").opid,a=e.getCurrentInstance(),l=e.ref(null),s=async()=>{u();try{const e=await t.scanCode();console.log("result",e),e&&d(e).then((()=>{z.value.length>0&&(l.value.inputText=z.value[0].ch)}))}catch(e){console.error("扫码失败：",e)}finally{c()}},u=()=>{e.index.showLoading({title:"加载中...",mask:!0})},c=()=>{e.index.hideLoading()},r=e.ref(!1),f=e.ref(null),m=e.ref("ch"),p=e.ref("ch"),d=e=>{e.length>0&&M(e)},g=o=>{console.log("e:",o),r.value=!1,e.index.showModal({content:"退出质检流程再次质检请根据串号搜索",showCancel:!0,success:e=>{e.cancel?r.value=!0:(console.log("用户点击了确认"),t.navigateToPage("pagesCustomMine/customMine/customMine"))}})},x=e.ref(!1),h=e.ref(null),v=e.ref(),w=e.ref(""),k=()=>{console.log("Popup is closed"),h.value.close()},j=e=>{e.show||(x.value=e.show)},L=e.ref([{title:"上传图片",tips:"* 机身背面为封面图",items:[{text:"机身背面",image:"https://www.xzxskj.com/xcximg/img_add_img@3x.png",fileList:[]},{text:"屏幕息屏",image:"https://www.xzxskj.com/xcximg/img_add_closewindow@3x.png",fileList:[]},{text:"关于本机",image:"https://www.xzxskj.com/xcximg/img_add_about@3x.png",fileList:[]}]},{title:"中框四面",items:[{text:"中框上方",image:"https://www.xzxskj.com/xcximg/img_add_upward@3x.png",fileList:[]},{text:"中框右侧",image:"https://www.xzxskj.com/xcximg/img_add_right@3x.png",fileList:[]},{text:"中框下方",image:"https://www.xzxskj.com/xcximg/img_add_downward@3x.png",fileList:[]},{text:"中框左侧",image:"https://www.xzxskj.com/xcximg/img_add_left@3x.png",fileList:[]}]},{title:"机身四角",items:[{text:"左上角",image:"https://www.xzxskj.com/xcximg/img_add_lefttop@3x.png",fileList:[]},{text:"右上角",image:"https://www.xzxskj.com/xcximg/img_add_righttop@3x.png",fileList:[]},{text:"右下角",image:"https://www.xzxskj.com/xcximg/img_add_rightdown@3x.png",fileList:[]},{text:"左下角",image:"https://www.xzxskj.com/xcximg/img_add_leftdown@3x.png",fileList:[]}]}]),_=e.ref(""),z=e.ref([]),y=e=>{if(F.value=null,L.value.forEach((e=>{e.items.forEach((e=>{e.fileList=[]}))})),console.log("selectChange:",e),e){console.log("selectChange e:",e);const{name:o,ch:n,machinetime:i,jkuidname:a,id:l,functionaltime:s,gnjcuidname:u,servicetime:c,serviceuidname:r,cgyname:f,productimage:m,pzbz:p,jkbz:d,gnjcbz:g,wxjcbz:x,csbz:h}=e;if(F.value={spname:o,imei:n,inputTime:t.formatTimestamp(i),inputPerson:a,funcInputTime:t.formatTimestamp(s),funcInputPerson:u,maintenanceInputTime:t.formatTimestamp(c),maintenanceInputPerson:r,cgyname:f,zjid:l},_.value=d+" "+g+" "+x+" "+h,w.value=p,m){const e=m.split(",");let t=0;L.value.forEach((o=>{o.items.forEach((o=>{t<e.length&&(o.fileList.push({url:e[t],name:o.text}),t++)}))}))}}},C=async()=>{const t={opid:i,id:F.value.zjid,tplist:b(L.value).join(","),bz:w.value};1===(await o.apiQualityCheckUploadPhoto(t)).zt?(F.value.pzbz=w.value,"QC"!==E.value?(v.value=L.value[0].items[0].fileList[0].url,x.value=!0,f.value.getData(F.value.imei),h.value.open()):e.index.showToast({title:"提交成功",icon:"none",duration:2e3})):e.index.showToast({title:"上传失败，请重试",icon:"none",duration:500})},b=e=>e.flatMap((e=>e.items.flatMap((e=>e.fileList.map((e=>e.url)))))).filter((e=>void 0!==e)),P=()=>{console.log("data:",L.value),I()&&C()},I=()=>{for(let t of L.value)for(let o of t.items)if(0===o.fileList.length)return e.index.showToast({title:`${o.text} 还未上传图片`,icon:"none",duration:2e3}),!1;return!0},T=()=>{L.value.forEach((e=>{e.items.forEach((e=>{e.fileList=[]}))})),w.value="",L.value=[...L.value],console.log("重置完成")},M=async e=>{const t={opid:i,ch:e},n=await o.apiQualityCheckSerialSearch(t);if(200===n.code)return n.lists=n.lists.filter((e=>""!==e.finenessname)),z.value=n.lists?n.lists:[]},S=()=>{e.index.showToast({title:"文件大小超出限制",icon:"none",duration:2e3})},q=()=>{T(),e.index.navigateTo({url:"/pagesOneClickUpload/oneClickUpload/oneClickUpload"})},F=e.ref(null),E=e.ref("");return e.onShow((()=>{const t=e.index.getStorageSync("photoData");t&&(L.value=t)})),e.onLoad((e=>{if(e.data)try{r.value=!0,F.value=JSON.parse(decodeURIComponent(e.data)),_.value=F.value.jkbz+" "+F.value.gnjcbz+" "+F.value.wxjcbz+" "+F.value.csbz,console.log("Received data:",F.value)}catch(t){console.error("Failed to parse received data:",t)}e.ch&&M(e.ch).then((e=>{y(e[0])})),e.from&&(E.value=e.from)})),(o,n)=>e.e({a:e.unref(r)&&e.unref(F)},e.unref(r)&&e.unref(F)?{b:e.unref(r),c:e.o(g)}:{},{d:e.p({backgroundColor:"#F3F2F6"}),e:e.sr(l,"f5acefee-1",{k:"searchInputRef"}),f:e.o(d),g:e.o(y),h:e.p({keyId:7,dataList:e.unref(z),phText:"请输入串号",searchKey:e.unref(m),showBorder:!1,disabled:!1,showField:e.unref(p)}),i:e.o(s),j:e.unref(F)},e.unref(F)?{k:e.t(e.unref(F).spname),l:e.t(e.unref(F).imei),m:e.o((t=>e.unref(a).proxy.copyText(e.unref(F).imei))),n:e.t(e.unref(F).cgyname),o:e.t(e.unref(F).inputPerson),p:e.t(e.unref(F).funcInputPerson),q:e.t(e.unref(F).maintenanceInputPerson),r:e.t(e.unref(_))}:{},{s:!e.unref(F)},e.unref(F)?{}:{t:e.p({description:"请搜索相关商品进行拍照"})},{v:e.unref(F)},e.unref(F)?{w:e.f(e.unref(L),((o,n,i)=>e.e({a:e.t(o.title),b:0===n},0===n?{c:e.t(o.tips)}:{},{d:e.f(o.items,((o,n,a)=>({a:o.image,b:e.o((e=>(async(e,o)=>{console.log("上传前 data：",L.value),console.log("item:",o),console.log("event",e),o.fileList=[],await t.takePhotoUploadFiles(e,o)})(e,o)),n),c:e.o(S,n),d:"f5acefee-3-"+i+"-"+a,e:e.p({fileList:o.fileList,name:"1",multiple:!0,accept:"image",maxCount:1,maxSize:"5242880",width:"0",height:"0",sizeType:["compressed"],previewFullImage:!1,previewFullVideo:!1}),f:e.f(o.fileList,((t,n,i)=>({a:t.url,b:e.t(t.name),c:e.o((e=>((e,t,o,n)=>{e.fileList&&(e.fileList.splice(n,1),console.log("删除后的fileList:",e.fileList)),L.value=[...L.value],console.log("data.value:",L.value)})(o,0,0,n)),n),d:n,e:e.o((o=>(t=>{const o=L.value.flatMap((e=>e.items.flatMap((e=>e.fileList.map((e=>e.url))))));console.log("data:",L.value),console.log("url:",t);const n=o.indexOf(t);console.log("current:",n),e.index.previewImage({showmenu:!0,current:n,urls:o,longPressActions:{itemList:["发送给朋友","保存图片","收藏"],success:function(e){console.log("选中了第"+(e.tapIndex+1)+"个按钮,第"+(e.index+1)+"张图片")},fail:function(e){console.log(e.errMsg)}}})})(t.url)),n)}))),g:n}))),e:n})))}:{},{x:e.unref(F)},e.unref(F)?{y:e.unref(w),z:e.o((t=>e.isRef(w)?w.value=t.detail.value:null))}:{},{A:e.unref(F)},(e.unref(F),{}),{B:e.unref(F)},e.unref(F)?{C:e.o(T),D:e.o(P)}:{},{E:e.sr(f,"f5acefee-5,f5acefee-4",{k:"takePhotoConfirmPannelRef"}),F:e.o(k),G:e.p({receivedData:e.unref(F),image:e.unref(v)}),H:e.sr(h,"f5acefee-4",{k:"pannelPopup"}),I:e.o(k),J:e.o(j),K:e.p({"background-color":"rgba(0,0,0,0)","is-mask-click":!0,"safe-area":!1,type:"center"}),L:e.unref(F)},e.unref(F)?{M:e.o(q)}:{})}},u=e._export_sfc(s,[["__scopeId","data-v-f5acefee"]]);wx.createPage(u);
