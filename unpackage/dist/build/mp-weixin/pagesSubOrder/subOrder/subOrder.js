"use strict";const e=require("../../common/vendor.js"),o=require("../api/api.js"),a=require("../../api/shopCard/shopCard.js"),n=require("../../api/subOrder/subOrder.js"),s=require("../../api/address/address.js"),t=require("../../stores/menuPermissionStore.js");if(!Array){(e.resolveComponent("custom-header")+e.resolveComponent("van-image")+e.resolveComponent("van-tag")+e.resolveComponent("uni-popup"))()}const i=()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js";Math||((()=>"../../components/custom-header/custom-header.js")+e.unref(r)+i+e.unref(l))();const r=()=>"./components/payPannel.js",l=()=>"./components/rulePannel.js",u={__name:"subOrder",setup(i){const r=t.usePermissionStore(),l=e.ref(!1),u=e.ref(),d=e.ref(),c=e.ref([]),p=e.ref(),g=e.ref(),f=e.ref(),v=e.ref(),m=e.ref(!1),y=e.ref(),x=e.ref(),S=e.ref([{image:"https://www.xzxskj.com/xcximg/icon_shunfeng@3x.png",value:"顺丰",expressId:"2"},{image:"https://www.xzxskj.com/xcximg/icon_jingdong@3x.png",value:"京东",expressId:"1"},{image:"https://www.xzxskj.com/xcximg/icon_songhuo@3x.png",value:"送货上门",expressId:"3"},{image:"https://www.xzxskj.com/xcximg/icon_ziti@3x.png",value:"自提",expressId:"4"}]),h=e.ref(0),w=async e=>{h.value=e,"顺丰"===S.value[e].value&&await N(),"京东"===S.value[e].value&&await L(),"送货上门"===S.value[e].value&&(J.value=[]),"自提"===S.value[e].value&&(J.value=[])},b=e.ref(null),j=e.ref(null),k=()=>{console.log("Popup is closed"),b.value.close(),j.value.close()},I=e=>{m.value=e.show},z=()=>{r.loadMenuAuthority();const o=e.index.getStorageSync("adminId");r.hasMenuAuthority("fastWholesale")&&""!==o&&(l.value=!0),console.log("fpbkShow",l.value),console.log("settlementList",c.value),b.value.open()},_=()=>{j.value.open()},O=o=>{e.index.navigateTo({url:o})},P=e.ref(""),C=async()=>{const a={opid:e.index.getStorageSync("sessionInfo").opid,goodsid:x.value,price:d.value,payment:"1",bargainingtimeid:u.value,addressid:M.value[0].id,expressid:S.value[h.value].expressId,remarks:p.value?p.value:""},n=await o.apiBargainingSubmit(a);if(200===n.code){const a={id:n.id,opid:e.index.getStorageSync("sessionInfo").opid},s=await o.apiBargainingWxPay(a);console.log("wx支付参数:",s);const t={nonceStr:s.nonceStr,package:s.package,paySign:s.paySign,timeStamp:s.timeStamp,signType:s.signType};P.value=s.out_trade_no,T(t)}},A=async()=>{const a={shoppingcartid:R.value,addressid:M.value[0].id,expressid:S.value[h.value].expressId,price:v.value,num:f.value,payment:"1",remarks:p.value?p.value:"",parameter:g.value,opid:e.index.getStorageSync("sessionInfo").opid,zyf:F(),gysyf:JSON.stringify(J.value.map((e=>({companyId:e.companyId,yf:e.price}))))},s=await n.apiSubmitorder(a);if(200===s.code){const a={id:s.id,opid:e.index.getStorageSync("sessionInfo").opid},n=await o.apiGetWxPay(a);console.log("wx支付参数:",n);const t={nonceStr:n.nonceStr,package:n.package,paySign:n.paySign,timeStamp:n.timeStamp,signType:n.signType};P.value=n.out_trade_no,T(t)}},T=o=>{e.index.requestPayment({provider:"wxpay",...o,success(o){console.log("success:"+JSON.stringify(o)),console.log("支付成功"),e.index.showToast({title:"支付成功！",icon:"none"}),e.index.redirectTo({url:"/pagesPaySuccess/paySuccess/paySuccess?orderNo="+P.value})},fail(o){console.log("pay fail:",JSON.stringify(o)),console.log("支付失败"),"1"===y.value||e.index.navigateTo({url:"/pagesOrder/order/order?order=3"})}})},q=()=>{const e={};c.value.forEach((o=>{const a=o.goodsinfos.shopid,n=o.goodsinfos.id;e[a]||(e[a]=[]),e[a].push({goodsid:n})}));return Object.entries(e).map((([e,o])=>({companyId:e,goodsinfos:o})))},J=e.ref([]),L=async()=>{if(J.value=[],M.value.length>0){const a={opid:e.index.getStorageSync("sessionInfo").opid,addid:M.value[0].id,goodsid:JSON.stringify(q())},n=await o.apiGetJdFreight(a);"200"===n.code&&(J.value=n.yflist),console.log("京东运费:",n)}},N=async()=>{if(J.value=[],M.value.length>0){const e={addid:M.value[0].id,goodsid:JSON.stringify(q())},a=await o.apiGetSfFreight(e);"200"===a.code&&(J.value=a.yflist),console.log("顺丰运费:",a)}},F=()=>{let e=0;return console.log("yflist.value",J.value),J.value&&J.value.forEach((o=>{e+=parseFloat(o.price)})),e},M=e.ref([]),D=e.ref(null),E=async()=>{if(D.value)M.value=[D.value];else{const o={opid:e.index.getStorageSync("sessionInfo").opid},a=await s.apigetAddress(o);a.lists&&a.lists.length>0?(M.value=a.lists.filter((e=>"1"===e.zt)),console.log("addressList1:",M.value)):M.value=[],console.log("addressList2:",M.value)}};e.computed((()=>{}));const G=()=>{const e=F();return parseFloat(v.value)+e},B=()=>{const e=F();return parseFloat(d.value)+e},R=e.computed((()=>{let e="";return c.value&&(e=c.value.map((e=>e.id)).join(",")),e})),W=e.ref(),H=e=>{k(),W.value=e,console.log("选择的支付类型：",e)};function K(e){console.log("data computed",e);const o={};return e.forEach((e=>{console.log("item",e);const a=e.goodsinfos.shopid,n=e.byzt;void 0!==a?(o[a]||(o[a]={shopid:a,byzt:n,goodinfos:[]}),e.goodsinfos?o[a].goodinfos.push(e.goodsinfos):console.warn("goodinfos is undefined for item:",e)):console.warn("shopid is undefined for item:",e)})),console.log("groupedData",o),Object.values(o)}e.onShow((async()=>{console.log("onShow");let e=getCurrentPages();const o=e[e.length-1];console.log("onShow:",o.data.selectedAddress),o.data.selectedAddress&&(D.value=o.data.selectedAddress),await E(),await L()}));const Q=e.ref();return e.onLoad((async o=>{let n=e.ref();const s=JSON.parse(decodeURIComponent(o.data));console.log("sub接收的参数data:",s),Q.value=s.id,n.value=s.id,x.value=s.id,console.log("sub接收的参数:",n.value),u.value=s.bargainingtimeid,d.value=s.price,y.value=s.lx,console.log("lxType.value:",y.value),await(async o=>{const n={opid:e.index.getStorageSync("sessionInfo").opid,goodsid:o,lx:"1"===y.value?"1":""},s=await a.apiSettleShopCard(n);if(console.log("结算信息:",s),200===s.code){g.value=s.parameter,c.value=s.goodslist,f.value=s.num,v.value=s.pirce,console.log("settlementList:",c.value);const o=e.index.getStorageSync("adminId"),a=e.index.getStorageSync("selectedMine"),n=e.index.getStorageSync("identityData");o&&a&&n&&(c.value=c.value.map((e=>{if(!e)return console.warn("good is undefined"),{};const o=n[a];return{...e,mineCompany:!!o&&e.gsid===o.gsid}}))),console.log("settlementList",c.value)}})(n.value),await E(),await N()})),(o,a)=>e.e({a:e.unref(M).length>0},e.unref(M).length>0?e.e({b:"1"===e.unref(M)[0].zt},(e.unref(M)[0].zt,{}),{c:e.t(e.unref(M)[0].province),d:e.t(e.unref(M)[0].city),e:e.t(e.unref(M)[0].area),f:e.t(e.unref(M)[0].address),g:e.t(e.unref(M)[0].name),h:e.t(e.unref(M)[0].phone),i:e.o((e=>O("/pagesAddress/address/address?from=subOrder"))),j:e.f(e.unref(S),((o,a,n)=>e.e({a:o.image,b:e.t(o.value),c:e.unref(h)===a},(e.unref(h),{}),{d:a,e:e.unref(h)===a?1:"",f:e.o((e=>w(a)),a)})))}):{k:e.o((e=>O("/pagesAddress/address/address?from=subOrder"))),l:e.f(e.unref(S),((o,a,n)=>e.e({a:o.image,b:e.t(o.value),c:e.unref(h)===a},(e.unref(h),{}),{d:a,e:e.unref(h)===a?1:"",f:e.o((e=>w(a)),a)})))},{m:e.unref(c).length>0},e.unref(c).length>0?{n:e.f(K(e.unref(c)),((o,a,n)=>{return e.e({a:e.f(o.goodinfos,((o,a,s)=>e.e({a:"27f62893-1-"+n+"-"+s,b:e.p({width:"190rpx",height:"190rpx",radius:"18rpx",src:o.cover,fit:"fill"}),c:o.finenessname},o.finenessname?{d:e.t(o.finenessname)}:{},{e:e.t(o.name),f:e.t(o.gjbbname),g:e.t(o.wlbbname),h:e.t(o.gjbbname),i:e.t(o.efficiency),j:e.t(o.delivery),k:e.t(o.price),l:a}))),b:1===o.byzt},1===o.byzt?{c:"27f62893-2-"+n,d:e.p({size:"mini",plain:!0,textColor:"#669CFD"})}:{},{e:e.t((s=o.shopid,J.value&&J.value.length>0&&(null==(t=J.value.find((e=>e.companyId===s)))?void 0:t.price)||"0")),f:a});var s,t}))}:{},{o:e.unref(c)},e.unref(c)?{p:e.t(e.unref(v)),q:e.o(_),r:e.t(F()),s:e.t(e.unref(f)),t:e.t(G())}:{},{v:e.unref(W)?e.unref(W).image:"https://www.xzxskj.com/xcximg/icon_weixin@3x.png",w:e.t(e.unref(W)?e.unref(W).text:"微信支付"),x:e.o(z),y:e.o(k),z:e.o(H),A:e.p({show:e.unref(l),settlementList:e.unref(c)}),B:e.sr(b,"27f62893-3",{k:"payPopup"}),C:e.o(k),D:e.o(I),E:e.p({"background-color":"rgba(0,0,0,0)","is-mask-click":!0,"safe-area":!1,type:"bottom"}),F:e.o(k),G:e.sr(j,"27f62893-5",{k:"rulePopup"}),H:e.o(k),I:e.o(I),J:e.p({"background-color":"rgba(0,0,0,0)","is-mask-click":!0,"safe-area":!1,type:"bottom"}),K:e.unref(p),L:e.o((o=>e.isRef(p)?p.value=o.detail.value:null)),M:!e.unref(m),N:e.t("1"===e.unref(y)?"议价:":"合计:"),O:e.t("1"===e.unref(y)?B():G()),P:"2"===e.unref(y)},"2"===e.unref(y)?{Q:e.o(A)}:{},{R:"1"===e.unref(y)},"1"===e.unref(y)?{S:e.o(C)}:{})}},d=e._export_sfc(u,[["__scopeId","data-v-27f62893"]]);wx.createPage(d);
