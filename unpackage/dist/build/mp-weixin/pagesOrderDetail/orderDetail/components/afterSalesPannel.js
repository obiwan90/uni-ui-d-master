"use strict";const e=require("../../../common/vendor.js"),o=require("../../../api/address/address.js"),i=require("../../api/api.js"),n=require("../../../utils/debounce.js");if(!Array){(e.resolveComponent("van-image")+e.resolveComponent("uv-upload")+e.resolveComponent("uv-transition")+e.resolveComponent("uni-popup-dialog")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../../uni_modules/uv-upload/components/uv-upload/uv-upload.js")+(()=>"../../../uni_modules/uv-transition/components/uv-transition/uv-transition.js")+(()=>"../../../uni_modules/uni-popup/components/uni-popup-dialog/uni-popup-dialog.js")+(()=>"../../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const s={__name:"afterSalesPannel",props:{itemIndex:{type:Number,required:!0}},emits:["close"],setup(s,{emit:t}){const r=e.ref(null),d=e.ref(!1),a=e.ref(),l=()=>{d.value=!0,r.value.open()},u=()=>{d.value=!1,console.log("close"),r.value.close()},f=async e=>{a.value=e,r.value.close(),d.value=!1},c=e.ref(null),p=e.ref(!0);e.ref(!1),e.ref(!1),e.ref(!1),e.ref(!1),e.ref();const g=e.ref(),m=s,x=t,h=e.ref([{type:"1",title:"申请退款"},{type:"2",title:"申请补差"},{type:"3",title:"退货退款"},{type:"4",title:"售后维修"}]);e.ref([{type:"1",text:"上门取件"},{type:"2",text:"自行寄回"}]);const v=e.ref(0);e.ref(0);const w=e=>{console.log(e),console.log("进来了吗");let o=[];return"1"===e.zt&&(e.goodsinfos.gjbbname&&o.push(e.goodsinfos.gjbbname),e.goodsinfos.wlbbname&&o.push(e.goodsinfos.wlbbname),e.goodsinfos.bxzt&&o.push(e.goodsinfos.bxzt),e.goodsinfos.efficiency&&o.push(`电池${e.goodsinfos.efficiency}%`),e.goodsinfos.delivery&&o.push(`${e.goodsinfos.delivery}发货`)),o.join("丨")},y=e.ref([]),b=async o=>{let i=[].concat(o.file);for(const s of i)try{const o=await I(s);if(!o)continue;const i=await e.index.uploadFile({url:"https://www.xzxskj.com/Home/Upload/add",filePath:o.tempFilePath,name:"imgs",header:{"Content-Type":"multipart/form-data"}}),n=JSON.parse(i.data);if(200!==n.code)throw new Error("上传失败");n.urls.split(",").forEach((e=>{e.trim()&&y.value.push({url:"https://www.xzxskj.com"+e.trim(),status:"success",message:""})}))}catch(n){e.index.showToast({title:n.message||"上传失败",icon:"error",duration:2e3})}},I=async o=>{const i=o.size;let n;if(e.index.showLoading({title:"loading...",mask:!0}),i>512e3){let i,s,t=80,r=!1;do{n=await e.index.compressImage({src:o.url,quality:t});const d=await e.index.getFileInfo({filePath:n.tempFilePath});if(i=t,s=d.size,d.size<=512e3){r=!0;break}t-=10}while(t>=20);if(e.index.hideLoading(),!r)return console.log(`最后一次压缩质量: ${i}, 大小: ${(s/1024/1024).toFixed(2)} MB`),e.index.showToast({title:"无法压缩到500KB以内，请尝试其他图片。",icon:"none"}),null}else n={tempFilePath:o.url};return e.index.hideLoading(),{tempFilePath:n.tempFilePath,url:n.tempFilePath}},j=e=>{y.value.splice(e.index,1)},T=()=>{e.index.showToast({title:"超出上传限制",icon:"error",duration:2e3})},z=n.debounce((()=>{P()}),300,!0),P=async()=>{const o={id:-1===m.itemIndex?c.value.orderid:c.value.goodsinfos[m.itemIndex].gysddh,opid:e.index.getStorageSync("sessionInfo").opid,lx:-1===m.itemIndex?1:2,shlx:h.value[v.value].type,shyy:g.value,shtp:y.value.map((e=>e.url)).join(","),bcje:a.value,goodsid:-1===m.itemIndex?"":c.value.goodsinfos[m.itemIndex].goodsid};if(!o.id)return void e.index.showToast({title:"订单ID不能为空",icon:"error",duration:3e3});if(!o.shlx)return void e.index.showToast({title:"申请类型不能为空",icon:"error",duration:3e3});if(!o.shyy)return void e.index.showToast({title:"申请理由不能为空",icon:"error",duration:3e3});if(!o.shtp)return void e.index.showToast({title:"请上传相关图片",icon:"error",duration:3e3});if(3!==v.value&&(!o.bcje||o.bcje<=0))return void e.index.showToast({title:"补偿金额必须大于0",icon:"error",duration:3e3});let n=0;if(n=-1===m.itemIndex?c.value.goodsinfos.reduce(((e,o)=>e+o.goodsinfos.price),0):c.value.goodsinfos[m.itemIndex].goodsinfos.price,parseFloat(o.bcje)>n)e.index.showToast({title:`超过总金额: ￥${n}`,icon:"error",duration:3e3});else{e.index.showLoading({title:"提交中...",mask:!0});try{const n=await i.apiOrderAftersales(o);console.log("res:",n),200===n.code?e.index.showToast({title:"申请提交成功",icon:"success",duration:3e3}):201===n.code?e.index.showToast({title:"请勿重复操作",icon:"error",duration:3e3}):e.index.showToast({title:"申请提交失败",icon:"error",duration:3e3})}catch(s){console.error("请求出错:",s),e.index.showToast({title:"提交请求失败",icon:"error",duration:3e3})}finally{e.index.hideLoading()}setTimeout((()=>{x("close")}),1e3)}},F=e.ref();return e.ref(null),e.onShow((()=>{console.log("onShow");let e=getCurrentPages();const o=e[e.length-1];console.log("onShow:",o.data.selectedAddress),o.data.selectedAddress&&(console.log("prevPage.data.selectedAddress:",o.data.selectedAddress),F.value=o.data.selectedAddress)})),e.onMounted((()=>{const i=e.index.getStorageSync("orderDetailItem");console.log("itemString:",i),i&&(c.value=JSON.parse(i)),(async e=>{const i={id:e},n=await o.apigetAddressDetail(i);F.value=n.info,console.log(n)})(c.value.addressid)})),(o,i)=>e.e({a:e.unref(c)},e.unref(c)?e.e({b:e.o((e=>o.$emit("close"))),c:-1===m.itemIndex},-1===m.itemIndex?{d:e.f(e.unref(c).goodsinfos,((o,i,n)=>e.e({a:"c8a2b09c-1-"+n+",c8a2b09c-0",b:e.p({width:"190rpx",height:"190rpx",radius:"18rpx",src:o.goodsinfos.cover,fit:"fill"}),c:e.t(o.goodsinfos.finenessname),d:e.t(o.goodsinfos.name),e:"1"===o.goodsinfos.zt},"1"===o.goodsinfos.zt?{f:e.t(w(o))}:{g:e.t(o.goodsinfos.ch)},{h:e.t(o.goodsinfos.price)},(e.unref(c).isBargaining,{}),e.unref(c).isBargaining?{i:e.t(o.goodsinfos.originalPrice)}:{},{j:i}))),e:!e.unref(c).isBargaining,f:e.unref(c).isBargaining}:e.e({g:e.p({width:"190rpx",height:"190rpx",radius:"18rpx",src:e.unref(c).goodsinfos[m.itemIndex].goodsinfos.cover,fit:"fill"}),h:e.t(e.unref(c).goodsinfos[m.itemIndex].goodsinfos.finenessname),i:e.t(e.unref(c).goodsinfos[m.itemIndex].goodsinfos.name),j:"1"===e.unref(c).goodsinfos[m.itemIndex].goodsinfos.zt},"1"===e.unref(c).goodsinfos[m.itemIndex].goodsinfos.zt?{k:e.t(w(e.unref(c).goodsinfos[m.itemIndex]))}:{l:e.t(e.unref(c).goodsinfos[m.itemIndex].goodsinfos.ch)},{m:e.t(e.unref(c).goodsinfos[m.itemIndex].goodsinfos.price),n:!e.unref(c).isBargaining},(e.unref(c).isBargaining,{}),{o:e.unref(c).isBargaining},e.unref(c).isBargaining?{p:e.t(e.unref(c).goodsinfos[m.itemIndex].goodsinfos.originalPrice)}:{}),{q:e.f(e.unref(h),((o,i,n)=>({a:e.t(o.title),b:i,c:e.unref(v)===i?1:"",d:e.o((e=>(e=>{v.value=e})(i)),i)}))),r:3!==e.unref(v)},3!==e.unref(v)?{s:e.t(e.unref(a)),t:e.o(l)}:{},{v:e.unref(g),w:e.o((o=>e.isRef(g)?g.value=o.detail.value:null)),x:e.o(b),y:e.o(j),z:e.o(T),A:e.p({fileList:e.unref(y),multiple:!0,maxCount:10,width:"162rpx",height:"162rpx",accept:"image",maxSize:"5242880",name:"2",previewFullVideo:!0}),B:e.o(((...o)=>e.unref(z)&&e.unref(z)(...o)))}):{},{C:e.p({show:e.unref(p),mode:"slide-bottom"}),D:e.unref(d)},e.unref(d)?{E:e.o(u),F:e.o(f),G:e.p({mode:"input",message:"成功消息",title:"输入价格","before-close":!0})}:{},{H:e.sr(r,"c8a2b09c-4",{k:"popup"}),I:e.p({type:"dialog"})})}},t=e._export_sfc(s,[["__scopeId","data-v-c8a2b09c"]]);wx.createComponent(t);
