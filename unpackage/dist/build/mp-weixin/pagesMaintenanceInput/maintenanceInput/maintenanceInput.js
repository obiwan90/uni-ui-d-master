"use strict";const e=require("../../common/vendor.js"),n=require("../../api/qualityCheck/qualityCheck.js"),o=require("../../utils/common.js");if(!Array){(e.resolveComponent("custom-header")+e.resolveComponent("van-empty")+e.resolveComponent("uv-upload")+e.resolveComponent("uni-collapse-item")+e.resolveComponent("uni-collapse")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../components/custom-header/custom-header.js")+l+(()=>"../../uni_modules/uv-upload/components/uv-upload/uv-upload.js")+(()=>"../../uni_modules/uni-collapse/components/uni-collapse-item/uni-collapse-item.js")+(()=>"../../uni_modules/uni-collapse/components/uni-collapse/uni-collapse.js")+a+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const l=()=>"../../uni_modules/qiao-select/components/qiao-select/qiaoSelect.js",a=()=>"./components/maintenanceInputConfirm.js",i={__name:"maintenanceInput",setup(l){const a=e.getCurrentInstance(),i=e.ref(null),t=async()=>{u();try{const e=await o.scanCode();console.log("result",e),e&&p(e).then((()=>{T.value.length>0&&(i.value.inputText=T.value[0].ch)}))}catch(e){console.error("扫码失败：",e)}finally{r()}},u=()=>{e.index.showLoading({title:"加载中...",mask:!0})},r=()=>{e.index.hideLoading()},s=e.ref(!1),c=e.ref(null),d=e.ref("ch"),f=e.ref("ch"),p=e=>{e.length>0&&F(e)},m=n=>{console.log("e:",n),s.value=!1,e.index.showModal({content:"退出质检流程再次质检请根据串号搜索",showCancel:!0,success:e=>{e.cancel?s.value=!0:(console.log("用户点击了确认"),o.navigateToPage("pagesCustomMine/customMine/customMine"))}})},v=e.ref("1"),h=e.reactive({}),g=e.ref([]),x=async o=>{const l=await n.apiQualityCheckList({lx:"3",ch:o});if(console.log("质检项：",l),200===l.code)return g.value=l.lists;e.index.showToast({title:l.msg,icon:"none"})},y=e.ref([]),k=e.ref([]),w=e.ref([]),j=(e,n)=>{k.value[e]=n,w.value[e]=n.name,console.log("selectedText:",w.value),console.log("clickedItems:",k.value),C(e)?y.value[e]=!0:y.value[e]=!1},C=e=>{g.value[e];const n=k.value[e];return n&&"1"===n.tpbs},I=(e,n)=>k.value[e]===n,b=e.reactive({remark:""}),T=e.ref([]),S=e=>{if(console.log("selectChange:",e),A.value=null,Object.keys(h).forEach((e=>{h[e]=[]})),e){console.log("selectChange e:",e);const{name:n,ch:l,machinetime:a,jkuidname:i,id:t,functionaltime:u,gnjcuidname:r,service:s,wxjcycbg:c,wxjcbz:d}=e;A.value={spname:n,imei:l,inputTime:o.formatTimestamp(a),inputPerson:i,funcInputTime:o.formatTimestamp(u),funcInputPerson:r,zjid:t},b.remark=d,x(l).then((()=>{if(k.value=new Array(g.value.length).fill(null),console.log("clickedItems.value：",k.value),s){s.split(",").map(Number).forEach((e=>{g.value.forEach(((n,o)=>{const l=n.er.find((n=>n.id==e));l&&(k.value[o]=l,w.value[o]=l.name,y.value[o]=!0)}))}))}if(c){JSON.parse(c).forEach((e=>{const n=g.value.findIndex((n=>n.id==e.id));-1!==n&&(h[n]||(h[n]=[]),h[n].push({url:e.url,itemId:e.id}))})),console.log("fileListRef:",h)}}))}},z=e.ref(null),_=e.ref(!0),q=()=>{console.log("Popup is closed"),z.value.close(),_.value=!0},L=e=>{console.log("点击了遮罩e:",e),_.value=!e.show},P=()=>{if(console.log("校验所有检测项是否已选择:",k.value),console.log("校验所有检测项是否已选择:",k.value.some((e=>!e))),k.value.some((e=>!e)))e.index.showToast({title:"请完成所有检测项",icon:"none",duration:500});else{for(let n=0;n<g.value.length;n++){const o=g.value[n];if(k.value[n],C(n)&&(!h[n]||0===h[n].length))return void e.index.showToast({title:`请上传 ${o.name} 的图片`,icon:"none",duration:500})}E()}},E=async()=>{const o=[];for(let e in h)h[e]&&h[e].forEach((e=>{o.push({id:e.itemId,url:e.url})}));const l={id:A.value.id,opid:JSON.parse(e.index.getStorageSync("userInfo")).opid,ch:A.value.imei,ycbgtplist:JSON.stringify(o),jbztid:k.value.map((e=>e.id)).join(","),jbztcolor:k.value.map((e=>e.color)).join(","),jkbz:b.remark,lx:"3",zjid:A.value.zjid},a=await n.apiQualityCheckAdd3(l);1===a.zt?(b.successId=a.ids,c.value.getData(A.value.imei),"QC"!==R.value?z.value.open():e.index.showToast({title:"提交成功",icon:"none",duration:2e3})):e.index.showToast({title:"录入失败，请重试",icon:"none",duration:2e3})},F=async o=>{e.index.showLoading({title:"加载中...."});const l={opid:e.index.getStorageSync("sessionInfo").opid,ch:o},a=await n.apiQualityCheckSerialSearch(l);if(200===a.code)return a.lists=a.lists.filter((e=>""!==e.functional)),console.log("apiQualityCheckSerialSearchData:",a),e.index.hideLoading(),T.value=a.lists?a.lists:[];e.index.hideLoading()},R=e.ref(""),A=e.ref(null);return e.onLoad((e=>{if(e.data)try{s.value=!0,A.value=JSON.parse(decodeURIComponent(e.data)),console.log("Received data:",A.value),x(A.value.imei).then((()=>{k.value=new Array(g.value.length).fill(null)}))}catch(n){console.error("Failed to parse received data:",n)}e.ch&&(console.log("进来了options:",e),F(e.ch).then((e=>{S(e[0])}))),e.from&&(R.value=e.from)})),(n,l)=>e.e({a:e.unref(s)&&e.unref(A)},e.unref(s)&&e.unref(A)?{b:e.unref(s),c:e.o(m)}:{},{d:e.sr(i,"f9d21915-1",{k:"searchInputRef"}),e:e.o(p),f:e.o(S),g:e.p({keyId:4,dataList:e.unref(T),phText:"请输入串号",searchKey:e.unref(d),showBorder:!1,disabled:!1,showField:e.unref(f)}),h:e.o(t),i:e.unref(A)},e.unref(A)?{j:e.t(e.unref(A).spname),k:e.t(e.unref(A).imei),l:e.o((n=>e.unref(a).proxy.copyText(e.unref(A).imei))),m:e.t(e.unref(A).inputPerson),n:e.t(e.unref(A).inputTime),o:e.t(e.unref(A).funcInputPerson),p:e.t(e.unref(A).funcInputTime)}:{},{q:!e.unref(A)},e.unref(A)?{}:{r:e.p({image:"search",description:"请搜索串号"})},{s:e.unref(g).length>0},e.unref(g).length>0?{t:e.f(e.unref(g),((n,l,a)=>e.e({a:e.t(n.name),b:e.t(e.unref(w)[l]),c:e.unref(y)[l]?1:"",d:e.f(n.er.slice(0,3),((n,o,a)=>({a:e.t(n.name),b:I(l,n)?1:"",c:I(l,n)?1:"",d:o,e:e.o((e=>j(l,n)),o)}))),e:n.er.length>3},n.er.length>3?{f:e.f(n.er.slice(3),((n,o,a)=>({a:e.t(n.name),b:I(l,n)?1:"",c:I(l,n)?1:"",d:o+3,e:e.o((e=>j(l,n)),o+3)})))}:{},{g:C(l)},C(l)?{h:e.o((e=>((e,n,l)=>{o.uploadFilesByIndex1(e,n,h,l)})(e,l,n.id)),l),i:e.o((n=>e.unref(o.uploadCheack)(n,l)),l),j:e.o((e=>((e,n)=>{o.uploadDeleteByIndex(e,n,h)})(e,l)),l),k:"f9d21915-5-"+a+",f9d21915-4-"+a,l:e.p({fileList:e.unref(h)[l]||[],accept:"image",maxCount:e.unref(v),maxSize:"5242880",width:"152rpx",height:"152rpx",sizeType:["compressed"],previewFullImage:!0,previewFullVideo:!1})}:{},{m:"f9d21915-4-"+a+",f9d21915-3-"+a,n:e.p({"show-arrow":!1,open:e.unref(y)[l],titleBorder:"none",border:!1}),o:e.sr("collapseRef","f9d21915-3-"+a,{f:1}),p:e.o((e=>((e,n)=>{console.log("面板：",e.length>0),y.value[n]=e.length>0})(e,l)),l),q:"f9d21915-3-"+a,r:l})))}:{},{v:e.unref(A)},e.unref(A)?{w:e.unref(b).remark,x:e.o((n=>e.unref(b).remark=n.detail.value))}:{},{y:e.unref(A)},(e.unref(A),{}),{z:e.unref(A)},e.unref(A)?{A:e.o(P)}:{},{B:e.unref(_),C:e.sr(c,"f9d21915-7,f9d21915-6",{k:"maintenanceInputConfirmRef"}),D:e.o(q),E:e.p({receivedData:e.unref(A)}),F:e.sr(z,"f9d21915-6",{k:"inputPopup"}),G:e.o(q),H:e.o(L),I:e.p({"background-color":"rgba(0,0,0,0)","is-mask-click":!0,"safe-area":!1,type:"bottom"})})}},t=e._export_sfc(i,[["__scopeId","data-v-f9d21915"]]);wx.createPage(t);
