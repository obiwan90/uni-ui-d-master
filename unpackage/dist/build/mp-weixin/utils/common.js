"use strict";const e=require("../common/vendor.js");const t=async t=>{const i=t.size;let s,r,n;if(console.log(`原始图片大小: ${(i/1024).toFixed(2)} KB`),e.index.showLoading({title:"loading...",mask:!0}),i<=512e3)return e.index.hideLoading(),console.log("图片大小已小于500KB，返回原图。"),{tempFilePath:t.url,url:t.url};try{const e=await o(t.url);r=e.width,n=e.height}catch(l){return e.index.hideLoading(),console.error("获取图片信息失败:",l),e.index.showToast({title:"获取图片信息失败，请检查图片URL。",icon:"none"}),null}let a=1;for(;;){const o=Math.floor(r*a),i=Math.floor(n*a);try{s=await e.index.compressImage({src:t.url,compressedWidth:o,compressedHeight:i})}catch(l){return e.index.hideLoading(),console.error("压缩图片失败:",l),e.index.showToast({title:"压缩图片失败，请重试。",icon:"none"}),null}let c;try{c=await e.index.getFileInfo({filePath:s.tempFilePath})}catch(l){return e.index.hideLoading(),console.error("获取压缩后图片信息失败:",l),e.index.showToast({title:"获取压缩后图片信息失败，请重试。",icon:"none"}),null}if(console.log(`压缩后图片大小: ${(c.size/1024).toFixed(2)} KB`),c.size<=512e3||a<=.2)break;a-=.1,console.log("质量:",a)}return e.index.hideLoading(),s?{tempFilePath:s.tempFilePath,url:s.tempFilePath}:(e.index.showToast({title:"无法压缩到500KB以内，请尝试其他图片。",icon:"none"}),null)},o=async t=>new Promise(((o,i)=>{e.index.getImageInfo({src:t,success:e=>{o({width:e.width,height:e.height})},fail:e=>{i(e)}})}));exports.compressImage=t,exports.convertDateStringToTimestamp=e=>{const t=new Date(e);return Math.floor(t.getTime()/1e3)},exports.copyText=function(t){e.index.setClipboardData({data:t,success:function(){e.index.showToast({title:"复制成功",icon:"success",duration:1500})},fail:function(t){console.error("复制失败",t),e.index.showToast({title:"复制失败，请重试",icon:"none",duration:1500})}})},exports.customTakePhotoUploadFiles=async(o,i)=>{console.log("上传文件:",o);try{const s=await t({url:o});if(!s)return;const r=await e.index.uploadFile({url:"https://www.xzxskj.com/Home/Upload/add",filePath:s.tempFilePath,name:"imgs",header:{"Content-Type":"multipart/form-data"}}),n=JSON.parse(r.data);if(200!==n.code)return console.error("上传失败:",n),void e.index.showToast({title:"上传失败,稍后再试",icon:"error",duration:2e3});console.log("上传成功:",n.urls);n.urls.split(",").forEach((e=>{e.trim()&&i.fileList.push({url:"https://www.xzxskj.com"+e.trim(),name:i.text})}))}catch(s){console.error("上传失败:",s),e.index.showToast({title:"上传失败",icon:"error",duration:2e3})}i.fileList=[...i.fileList],console.log("item.fileList:",i.fileList)},exports.formatTimestamp=e=>{const t=new Date(1e3*e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}:${String(t.getSeconds()).padStart(2,"0")}`},exports.getCurrentDateString=()=>{const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`},exports.navigateToPage=t=>{console.log("path:",t);let o=getCurrentPages();for(let i=0;i<o.length;i++)if(o[i].route===t)return void e.index.navigateBack({delta:o.length-i-1});return!1},exports.previewImages=(t,o="")=>{const i=t.indexOf(o);console.log("url:",o),console.log("urls:",t),console.log("current:",i),e.index.previewImage({showmenu:!0,current:i,urls:t,longPressActions:{itemList:["发送给朋友","保存图片","收藏"],success:function(e){console.log("选中了第"+(e.tapIndex+1)+"个按钮,第"+(e.index+1)+"张图片")},fail:function(e){console.log(e.errMsg)}}})},exports.saveImagesToAlbum=t=>{let o=!1,i=[],s=!1;const r=t=>{e.index.downloadFile({url:t,success:o=>{200===o.statusCode?e.index.saveImageToPhotosAlbum({filePath:o.tempFilePath,success:()=>{console.log(`图片 ${t} 已成功保存到相册`)},fail:e=>{console.error(`保存图片 ${t} 失败:`,e)}}):console.error(`下载图片 ${t} 失败, 状态码: ${o.statusCode}`)},fail:e=>{console.error(`下载图片 ${t} 失败:`,e)}})};t.forEach((t=>{o?r(t):(i.push(t),!s&&i.length>0&&(s=!0,e.index.showLoading({title:"正在保存图片...",mask:!0})),e.index.getSetting({success:t=>{t.authSetting["scope.writePhotosAlbum"]?(o=!0,i.forEach(r),i=[],e.index.hideLoading(),s=!1):e.index.authorize({scope:"scope.writePhotosAlbum",success:()=>{o=!0,i.forEach(r),i=[],e.index.hideLoading(),s=!1},fail:t=>{console.error("授权失败:",t),e.index.hideLoading(),s=!1}})},fail:t=>{console.error("获取授权设置失败:",t),e.index.hideLoading(),s=!1}}))}))},exports.scanCode=()=>new Promise(((t,o)=>{e.index.scanCode({scanType:["barCode"],success:function(e){switch(console.log("条码类型："+e.scanType),console.log("条码内容："+e.result),e.scanType){case"QR_CODE":case"EAN_13":case"barCode":case"datamatrix":case"pdf417":break;default:e.scanType}t(e.result)},fail:function(e){o(e)}})})),exports.takePhotoUploadFiles=async(o,i)=>{console.log("上传文件:",o);for(let r of o.file){console.log("file",r);try{const o=await t(r);if(!o)continue;const s=await e.index.uploadFile({url:"https://www.xzxskj.com/Home/Upload/add",filePath:o.tempFilePath,name:"imgs",header:{"Content-Type":"multipart/form-data"}}),n=JSON.parse(s.data);if(200!==n.code)return console.error("上传失败:",n),void e.index.showToast({title:"上传失败,稍后再试",icon:"error",duration:2e3});console.log("上传成功:",n.urls);n.urls.split(",").forEach((e=>{e.trim()&&i.fileList.push({url:"https://www.xzxskj.com"+e.trim(),name:i.text,type:r.type,isImage:r.type.startsWith("image"),isVideo:r.type.startsWith("video")})}))}catch(s){console.error("上传失败:",s),e.index.showToast({title:"上传失败",icon:"error",duration:2e3})}}i.fileList=[...i.fileList],console.log("item1.fileList:",i.fileList)},exports.toBeijingTimestamp=e=>{let t=new Date(e+"T00:00:00+08:00").getTime();return Math.floor(t/1e3)},exports.uploadCheack=(t,o)=>{console.log("好像超出限制了"),console.log(t),e.index.showToast({title:"超出上传限制",icon:"error",duration:2e3})},exports.uploadDelete=(e,t,o)=>{console.log("我在删除"),console.log(e);const i=e.index;o[t].value.splice(i,1),o[t].value=[...o[t].value]},exports.uploadDeleteByIndex=(e,t,o)=>{console.log("我在删除"),console.log(e);const i=e.index;o[t]?(o[t].splice(i,1),o[t]=[...o[t]]):console.error("fileListRef[index] 不存在:",t)},exports.uploadFiles=async(o,i,s)=>{let r=[].concat(o);console.log("lists:",r);for(let a of r){console.log("item:",a);try{const o=await t(a);if(!o)continue;const r=await e.index.uploadFile({url:"https://www.xzxskj.com/Home/Upload/add",filePath:o.tempFilePath,name:"imgs",header:{"Content-Type":"multipart/form-data"}}),n=JSON.parse(r.data);if(200!==n.code)return console.error("上传失败:",n),void e.index.showToast({title:"上传失败,稍后再试",icon:"error",duration:2e3});console.log("上传成功:",n.urls);n.urls.split(",").forEach((e=>{e.trim()&&s[i].value.push({url:"https://www.xzxskj.com"+e.trim(),name:"image"===a.type?"图片":"视频",type:a.type,isImage:a.type.startsWith("image"),isVideo:a.type.startsWith("video")})}))}catch(n){console.error("上传失败:",n),e.index.showToast({title:"上传失败",icon:"error",duration:2e3})}}s[i].value=[...s[i].value]},exports.uploadFilesByIndex=async(o,i,s,r)=>{s[i]||(s[i]=e.ref([]));let n=[].concat(o);console.log("lists:",n);for(let l of n){console.log("item:",l);try{const o=await t(l);if(!o)continue;const n=await e.index.uploadFile({url:"https://www.xzxskj.com/Home/Upload/add",filePath:o.tempFilePath,name:"imgs",header:{"Content-Type":"multipart/form-data"}}),a=JSON.parse(n.data);if(200!==a.code)return console.error("上传失败:",a),void e.index.showToast({title:"上传失败,稍后再试",icon:"error",duration:2e3});console.log("上传成功:",a.urls);a.urls.split(",").forEach((e=>{e.trim()&&s[i].push({url:"https://www.xzxskj.com"+e.trim(),name:"image"===l.type?"图片":"视频",type:l.type,isImage:l.type.startsWith("image"),isVideo:l.type.startsWith("video"),itemId:r||""})}))}catch(a){console.error("上传失败:",a),e.index.showToast({title:"上传失败",icon:"error",duration:2e3})}}s[i]=[...s[i]],console.log("fileListRef:",s)},exports.uploadFilesByIndex1=async(o,i,s,r)=>{s[i]||(s[i]=e.ref([]));let n=[].concat(o);console.log("lists:",n);for(let l of n){console.log("item:",l);try{const o=await t(l.file);if(!o)continue;const n=await e.index.uploadFile({url:"https://www.xzxskj.com/Home/Upload/add",filePath:o.tempFilePath,name:"imgs",header:{"Content-Type":"multipart/form-data"}}),a=JSON.parse(n.data);if(200!==a.code)return console.error("上传失败:",a),void e.index.showToast({title:"上传失败,稍后再试",icon:"error",duration:2e3});console.log("上传成功:",a.urls);a.urls.split(",").forEach((e=>{e.trim()&&s[i].push({url:"https://www.xzxskj.com"+e.trim(),name:"image"===l.file.type?"图片":"视频",type:l.file.type,isImage:l.file.type.startsWith("image"),isVideo:l.file.type.startsWith("video"),itemId:r||""})}))}catch(a){console.error("上传失败:",a),e.index.showToast({title:"上传失败",icon:"error",duration:2e3})}}s[i]=[...s[i]],console.log("fileListRef:",s)},exports.useShare=t=>{const o=e.reactive({title:t.title||"数码购机",path:t.path||"/pages/home/home",imageUrl:t.imageUrl||"https://www.xzxskj.com/Public/upload/667e2e7a1860b8225.jpeg",desc:t.desc||"专注技术分享",content:t.content||""});return{sharePath:o,onShareAppMessage:t=>({title:o.title,path:o.path,imageUrl:o.imageUrl,desc:o.desc,content:o.content,success(t){e.index.showToast({title:"分享成功"})},fail(t){e.index.showToast({title:"分享失败",icon:"none"})}}),onShareTimeline:()=>{}}};
