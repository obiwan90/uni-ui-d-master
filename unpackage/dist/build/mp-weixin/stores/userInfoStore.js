"use strict";const e=require("../common/vendor.js"),s=require("../api/member/member.js"),o=require("../api/shopCard/shopCard.js");require("./tokenStore.js");const n=e.defineStore({id:"userInfo",state:()=>({info:null,fetchingUserInfo:!1,shopCount:null}),actions:{async getInfo(){try{this.fetchingUserInfo=!0;const o=e.index.getStorageSync("sessionInfo");if(!o||!o.opid)throw new Error("Session info missing");const n={openid:o.opid},t=await s.apiGetUserInfo(n);t.info&&(this.setInfo(t.info),this.savePermissions(t.qxlists),e.index.setStorageSync("infos",t))}catch(o){console.error("获取用户信息失败:",o)}finally{this.fetchingUserInfo=!1}return this.info},setInfo(s){this.info=s,e.index.setStorageSync("userInfo",JSON.stringify(s)),e.index.setStorageSync("isLogin",!0)},savePermissions(s){if(s){const o=function(e){const s={route:[],menu:[],api:[]};return function e(o){for(const n of o)n.url.split(",").forEach((e=>{e.startsWith("route:")?s.route.push(e.slice(6)):e.startsWith("menu:")?s.menu.push(e.slice(5)):e.startsWith("api:")&&s.api.push(e.slice(4))})),n.lists&&n.lists.length>0&&e(n.lists)}(e),s}(s);e.index.setStorageSync("userAuthorityUrls",o),e.index.setStorageSync("qxlists",s)}},clearInfo(){this.info=null,e.index.removeStorageSync("userInfo"),e.index.removeStorageSync("isLogin"),e.index.removeStorageSync("qxlists"),e.index.removeStorageSync("userAuthorityUrls")},async refreshShopCarCount(){try{const s=e.index.getStorageSync("sessionInfo");if(!s||!s.opid)throw new Error("Session info missing");const n=await o.apigetShopCard({opid:s.opid});return"200"===n.code&&(this.shopCount=n.count),this.shopCount}catch(s){return console.error("刷新购物车数量失败:",s),null}}}});exports.useUserStore=n;
