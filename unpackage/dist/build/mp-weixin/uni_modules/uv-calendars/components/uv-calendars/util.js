"use strict";const t=require("./calendar.js");exports.Calendar=class{constructor({date:t,selected:e,startDate:a,endDate:s,range:r,multiple:i,allowSameDay:l}={}){this.date=this.getDate(new Date),this.selected=e||[],this.startDate=a,this.endDate=s,this.range=r,this.multiple=i,this.allowSameDay=l,this.cleanRangeStatus(),this.cleanMultipleStatus(),this.weeks={}}setDate(t,e){this.range&&"init"==e?(this.cleanRangeStatus(),Array.isArray(t)?(this.rangeStatus.before=t[0],this.rangeStatus.after=t.length>1?t[t.length-1]:"",this.rangeStatus.after&&this.dateCompare(this.rangeStatus.before,this.rangeStatus.after)&&(this.rangeStatus.data=this.geDateAll(this.rangeStatus.before,this.rangeStatus.after)),this.selectDate=this.getDate(t[0]),this._getWeek(this.selectDate.fullDate)):(this.selectDate=this.getDate(t),this.rangeStatus.before=this.selectDate.fullDate,this._getWeek(this.selectDate.fullDate))):this.multiple&&"init"==e?(this.cleanMultipleStatus(),Array.isArray(t)?(this.multipleStatus.data=t,this.selectDate=this.getDate(t[0]),this._getWeek(this.selectDate.fullDate)):(this.selectDate=this.getDate(t),this.multipleStatus.data=[this.selectDate.fullDate],this._getWeek(this.selectDate.fullDate))):Array.isArray(t)?(this.selectDate=this.getDate(t[0]),this._getWeek(this.selectDate.fullDate)):(this.selectDate=this.getDate(t),this._getWeek(this.selectDate.fullDate))}cleanRangeStatus(){this.rangeStatus={before:"",after:"",data:[]}}cleanMultipleStatus(){this.multipleStatus={data:[]}}resetSatrtDate(t){this.startDate=t}resetEndDate(t){this.endDate=t}getDate(t,e=0,a="day"){t||(t=new Date),"object"!=typeof t&&(t=t.replace(/-/g,"/"));const s=new Date(t);switch(a){case"day":s.setDate(s.getDate()+e);break;case"month":if(31===s.getDate()&&e>0)s.setDate(s.getDate()+e);else{const t=s.getMonth();s.setMonth(t+e);const a=s.getMonth();e<0&&0!==t&&a-t>e&&s.setMonth(a+(a-t+e)),e>0&&a-t>e&&s.setMonth(a-(a-t-e))}break;case"year":s.setFullYear(s.getFullYear()+e)}const r=s.getFullYear(),i=s.getMonth()+1<10?"0"+(s.getMonth()+1):s.getMonth()+1,l=s.getDate()<10?"0"+s.getDate():s.getDate();return{fullDate:r+"-"+i+"-"+l,year:r,month:i,date:l,day:s.getDay()}}_getLastMonthDays(t,e){let a=[];for(let s=t;s>0;s--){const t=new Date(e.year,e.month-1,1-s).getDate();a.push({date:t,month:e.month-1,lunar:this.getlunar(e.year,e.month-1,t),disable:!0})}return a}_currentMonthDys(t,e){let a=[],s=this.date.fullDate;for(let r=1;r<=t;r++){let t=e.year+"-"+(e.month,e.month+"-")+(r<10?"0"+r:r),i=s===t,l=this.selected&&this.selected.find((e=>{if(this.dateEqual(t,e.date))return e})),n=!0,h=!0;this.startDate&&(n=this.dateCompare(this.startDate,t)),this.endDate&&(h=this.dateCompare(t,this.endDate));let u=this.rangeStatus.data,g=!1,D=-1;this.range&&(u&&(D=u.findIndex((e=>this.dateEqual(e,t)))),-1!==D&&(g=!0));let o=this.multipleStatus.data,c=!1,f=-1;this.multiple&&(o&&(f=o.findIndex((e=>this.dateEqual(e,t)))),-1!==f&&(c=!0));let d={fullDate:t,year:e.year,date:r,range:!!this.range&&g,multiple:!!this.multiple&&c,beforeRange:this.dateEqual(this.rangeStatus.before,t),afterRange:this.dateEqual(this.rangeStatus.after,t),dateEqual:this.range&&g&&this.dateEqual(this.rangeStatus.before,this.rangeStatus.after),month:e.month,lunar:this.getlunar(e.year,e.month,r),disable:!(n&&h),isDay:i};l&&(d.extraInfo=l),a.push(d)}return a}_getNextMonthDays(t,e){let a=[];for(let s=1;s<t+1;s++)a.push({date:s,month:Number(e.month)+1,lunar:this.getlunar(e.year,Number(e.month)+1,s),disable:!0});return a}getInfo(t){t?Array.isArray(t)&&(t=t[0]):t=new Date;return this.canlender.find((e=>e.fullDate===this.getDate(t).fullDate))}dateCompare(t,e){return(t=new Date(t.replace("-","/").replace("-","/")))<=(e=new Date(e.replace("-","/").replace("-","/")))}dateEqual(t,e){return t=new Date(t.replace("-","/").replace("-","/")),e=new Date(e.replace("-","/").replace("-","/")),t.getTime()-e.getTime()==0}dateAfterLgBefore(t,e){return t=new Date(t.replace("-","/").replace("-","/")),(e=new Date(e.replace("-","/").replace("-","/"))).getTime()-t.getTime()>0}geDateAll(t,e){var a=[],s=t.split("-"),r=e.split("-"),i=new Date;i.setFullYear(s[0],s[1]-1,s[2]);var l=new Date;l.setFullYear(r[0],r[1]-1,r[2]);for(var n=i.getTime()-864e5,h=l.getTime()-864e5,u=n;u<=h;)u+=864e5,a.push(this.getDate(new Date(parseInt(u))).fullDate);return a}getlunar(e,a,s){return t.calendar.solar2lunar(e,a,s)}setSelectInfo(t,e){this.selected=e,this._getWeek(t)}setMultiple(t){if(!this.multiple)return;const e=this.multipleStatus.data.findIndex((e=>this.dateEqual(t,e)));e<0?this.multipleStatus.data=this.multipleStatus.data.concat([t]):this.multipleStatus.data.splice(e,1),this._getWeek(t)}setRange(t){let{before:e,after:a}=this.rangeStatus;if(this.range){if(e&&a)this.cleanRangeStatus(),this.rangeStatus.before=t;else if(e){if(this.allowSameDay&&this.dateEqual(e,t))this.rangeStatus.after=t;else if(!this.dateAfterLgBefore(this.rangeStatus.before,t))return this.cleanRangeStatus(),this.rangeStatus.before=t,void this._getWeek(t);this.rangeStatus.after=t,this.dateCompare(this.rangeStatus.before,this.rangeStatus.after)?this.rangeStatus.data=this.geDateAll(this.rangeStatus.before,this.rangeStatus.after):this.rangeStatus.data=this.geDateAll(this.rangeStatus.after,this.rangeStatus.before)}else this.rangeStatus.before=t;this._getWeek(t)}}_getWeek(t){const{year:e,month:a}=this.getDate(t);let s=new Date(e,a-1,1).getDay(),r=new Date(e,a,0).getDate(),i={lastMonthDays:this._getLastMonthDays(s,this.getDate(t)),currentMonthDys:this._currentMonthDys(r,this.getDate(t)),nextMonthDays:[],weeks:[]},l=[];const n=42-(i.lastMonthDays.length+i.currentMonthDys.length);i.nextMonthDays=this._getNextMonthDays(n,this.getDate(t)),l=l.concat(i.lastMonthDays,i.currentMonthDys,i.nextMonthDays);let h={};for(let u=0;u<l.length;u++)u%7==0&&(h[parseInt(u/7)]=new Array(7)),h[parseInt(u/7)][u%7]=l[u];this.canlender=l,this.weeks=h}};
