"use strict";const e=require("../../common/vendor.js"),o=require("../../common/assets.js"),n=require("../../utils/common.js"),a=require("../../api/qualityCheck/qualityCheck.js"),l=require("../../stores/menuPermissionStore.js");if(!Array){(e.resolveComponent("custom-header")+e.resolveComponent("van-empty")+e.resolveComponent("uv-upload")+e.resolveComponent("uni-collapse-item")+e.resolveComponent("uni-collapse")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../components/custom-header/custom-header.js")+i+(()=>"../../uni_modules/uv-upload/components/uv-upload/uv-upload.js")+(()=>"../../uni_modules/uni-collapse/components/uni-collapse-item/uni-collapse-item.js")+(()=>"../../uni_modules/uni-collapse/components/uni-collapse/uni-collapse.js")+u+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const i=()=>"../../uni_modules/qiao-select/components/qiao-select/qiaoSelect.js",u=()=>"./components/funcConfirm.js",t={__name:"funcCheck",setup(i){const u=e.getCurrentInstance(),t=e.ref(null),r=async()=>{s();try{const e=await n.scanCode();console.log("result",e),e&&g(e).then((()=>{z.value.length>0&&(t.value.inputText=z.value[0].ch)}))}catch(e){console.error("扫码失败：",e)}finally{c()}},s=()=>{e.index.showLoading({title:"加载中...",mask:!0})},c=()=>{e.index.hideLoading()},f=l.usePermissionStore(),d=e.ref(null),p=e.ref(null),m=e.ref(!1),v=e.ref("ch"),h=e.ref("ch"),g=async e=>{e.length>0&&await N(e)},y=o=>{console.log("e:",o),m.value=!1,e.index.showModal({content:"退出质检流程再次质检请根据串号搜索",showCancel:!0,success:e=>{e.cancel?m.value=!0:(console.log("用户点击了确认"),n.navigateToPage("pagesCustomMine/customMine/customMine"))}})},k=e.ref("1"),x=e.reactive({}),C=e.ref([]),j=async o=>{const n=await a.apiQualityCheckList({lx:"2",ch:o});if(200===n.code)return C.value=n.lists;e.index.showToast({title:n.msg,icon:"none"})},w=e.ref([]),b=e.ref([]),I=e.ref([]),S=(o,n)=>{b.value[o]=n,I.value[o]=n.name,T(o)?e.nextTick$1((()=>{w.value[o]=!0})):w.value[o]=!1},T=e=>{C.value[e];const o=b.value[e];return o&&"1"===o.tpbs},_=(e,o)=>b.value[e]===o,q=e.reactive({remark:"",imei:""}),z=e.ref([]),A=e=>{if(J.value=null,Object.keys(x).forEach((e=>{x[e]=[]})),console.log("selectChange:",e),e){console.log("selectChange e:",e);const{name:o,ch:a,machinetime:l,jkuidname:i,id:u,functional:t,gnjcycbg:r,gnjcbz:s}=e;J.value={spname:o,imei:a,inputTime:n.formatTimestamp(l),inputPerson:i,zjid:u,id:u},q.remark=s,console.log("receivedData:",J.value),j(a).then((()=>{if(b.value=new Array(C.value.length).fill(null),console.log("clickedItems.value：",b.value),t){t.split(",").map(Number).forEach((e=>{C.value.forEach(((o,n)=>{const a=o.er.find((o=>o.id==e));a&&(b.value[n]=a,I.value[n]=a.name,w.value[n]=!0)}))}))}if(r){JSON.parse(r).forEach((e=>{const o=C.value.findIndex((o=>o.id==e.id));-1!==o&&(x[o]||(x[o]=[]),x[o].push({url:e.url,itemId:e.id}))})),console.log("fileListRef:",x)}}))}},M=e.ref(null),P=e.ref(!0),D=()=>{console.log("Popup is closed"),M.value.close(),P.value=!0},E=e=>{console.log("点击了遮罩e:",e),P.value=!e.show},L=()=>{if(b.value.some((e=>!e)))e.index.showToast({title:"请完成所有检测项",icon:"none",duration:2e3});else{for(let o=0;o<C.value.length;o++){const n=C.value[o];if(b.value[o],T(o)&&(!x[o]||0===x[o].length))return void e.index.showToast({title:`请上传 ${n.name} 的图片`,icon:"none",duration:2e3})}B()}},R=e.ref(!1),F=()=>{f.loadMenuAuthority(),f.hasMenuAuthority("oneClickMachineVerification")?(R.value=!R.value,R.value?C.value.forEach(((e,o)=>{e.er&&e.er.length>0&&(b.value[o]=e.er[0],I.value[o]=e.er[0].name,w.value[o]=!0)})):Q()):e.index.showToast({title:"您没有操作权限",icon:"none",duration:2e3})},Q=()=>{b.value=[],I.value=[],w.value=C.value.map((()=>!1))},B=async()=>{var o;const n=[];for(let e in x)x[e]&&x[e].forEach((e=>{n.push({id:e.itemId,url:e.url})}));const l=(null==(o=b.value.find((e=>"49"===e.fid)))?void 0:o.id)||"",i={id:J.value.id,opid:JSON.parse(e.index.getStorageSync("userInfo")).opid,ch:J.value.imei,ycbgtplist:JSON.stringify(n),jbztid:b.value.map((e=>e.id)).join(","),jbztcolor:b.value.map((e=>e.color)).join(","),jkbz:q.remark,lx:"2",zjid:J.value.zjid,fcyjid:l},u=await a.apiQualityCheckAdd2(i);console.log("apiQualityCheckAddData:",u),1===u.zt?(q.successId=u.ids,d.value.getData(J.value.imei),"QC"!==O.value?M.value.open():e.index.showToast({title:"提交成功",icon:"none",duration:2e3})):e.index.showToast({title:"录入失败，请重试",icon:"none",duration:2e3})},N=async o=>{const n={opid:e.index.getStorageSync("sessionInfo").opid,ch:o},l=await a.apiQualityCheckSerialSearch(n);if(200===l.code)return z.value=l.lists?l.lists:[]},O=e.ref(""),J=e.ref(null);return e.onLoad((e=>{if(e.data){console.log("Received data:",e.data),m.value=!0;try{J.value=JSON.parse(decodeURIComponent(e.data)),console.log("Received data:",J.value),j(J.value.imei).then((()=>{b.value=new Array(C.value.length).fill(null)}))}catch(o){console.error("Failed to parse received data:",o)}}e.from&&(O.value=e.from),e.ch&&N(e.ch).then((e=>{console.log("apiQualityCheckSerialSearchData:",e),A(e[0])}))})),(a,l)=>e.e({a:e.unref(m)&&e.unref(J)},e.unref(m)&&e.unref(J)?{b:e.unref(m),c:e.o(y)}:{},{d:e.sr(t,"76acf33f-1",{k:"searchInputRef"}),e:e.o(A),f:e.o(g),g:e.p({keyId:13,dataList:e.unref(z),phText:"请输入串号",searchKey:e.unref(v),showBorder:!1,disabled:!1,showField:e.unref(h)}),h:e.o(r),i:!e.unref(J)},e.unref(J)?{}:{j:e.p({image:"search",description:"请搜索串号"})},{k:e.unref(J)},e.unref(J)?{l:e.t(e.unref(J).spname),m:e.t(e.unref(J).imei),n:e.o((o=>e.unref(u).proxy.copyText(e.unref(J).imei))),o:e.t(e.unref(J).inputPerson),p:e.t(e.unref(J).inputTime)}:{},{q:e.unref(C).length>0},e.unref(C).length>0?{r:e.f(e.unref(C),((a,l,i)=>e.e({a:e.t(a.name),b:e.t(e.unref(I)[l]),c:e.unref(w)[l]?1:"",d:e.f(a.er.slice(0,3),((o,n,a)=>({a:e.t(o.name),b:_(l,o)?1:"",c:_(l,o)?1:"",d:n,e:e.o((e=>S(l,o)),n)}))),e:a.er.length>3},a.er.length>3?{f:e.f(a.er.slice(3),((o,n,a)=>({a:e.t(o.name),b:_(l,o)?1:"",c:_(l,o)?1:"",d:n+3,e:e.o((e=>S(l,o)),n+3)})))}:{},{g:T(l)},T(l)?{h:o._imports_0$3,i:e.o((e=>((e,o,a)=>{n.uploadFilesByIndex1(e,o,x,a)})(e,l,a.id)),l),j:e.o((o=>e.unref(n.uploadCheack)(o,l)),l),k:e.o((e=>((e,o)=>{n.uploadDeleteByIndex(e,o,x)})(e,l)),l),l:"76acf33f-5-"+i+",76acf33f-4-"+i,m:e.p({fileList:e.unref(x)[l]||[],accept:"image",maxCount:e.unref(k),maxSize:"5242880",width:"152rpx",height:"152rpx",sizeType:["compressed"],previewFullImage:!0,previewFullVideo:!1})}:{},{n:"76acf33f-4-"+i+",76acf33f-3-"+i,o:e.p({"show-arrow":!1,open:e.unref(w)[l],titleBorder:"none",border:!1}),p:e.sr(p,"76acf33f-3-"+i,{k:"collapseRef",f:1}),q:e.o((e=>((e,o)=>{console.log("面板：",e.length>0),w.value[o]=e.length>0})(e,l)),l),r:"76acf33f-3-"+i,s:l})))}:{},{s:e.unref(J)},e.unref(J)?{t:e.unref(q).remark,v:e.o((o=>e.unref(q).remark=o.detail.value))}:{},{w:e.unref(J)},(e.unref(J),{}),{x:e.unref(J)},e.unref(J)?{y:e.t(e.unref(R)?"取消全选":"一键验机"),z:e.o(F),A:e.o(L)}:{},{B:e.unref(P),C:e.sr(d,"76acf33f-7,76acf33f-6",{k:"funcConfirmRef"}),D:e.o(D),E:e.p({receivedData:e.unref(J)}),F:e.sr(M,"76acf33f-6",{k:"inputPopup"}),G:e.o(D),H:e.o(E),I:e.p({"background-color":"rgba(0,0,0,0)","is-mask-click":!0,"safe-area":!1,type:"bottom"})})}},r=e._export_sfc(t,[["__scopeId","data-v-76acf33f"]]);wx.createPage(r);
